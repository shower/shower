<!DOCTYPE html>
<html lang="en">
<head>
	<title>Работа с изображениями на Python в 2017 году</title>
	<meta charset="utf-8">
	<meta http-equiv="x-ua-compatible" content="ie=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="node_modules/shower-ribbon/styles/screen-16x10.css">
	<style type="text/css">
		@page {
			size: 1024px 576px;
		}
		.shower.full {
			margin:-288px 0 0 -512px;
			height: 576px;
		}
		.slide {
			height: 576px;
			padding: 62px 80px 0 100px;
		}
		.slide:after {
			top: -20px;
			padding-top: 25px;
		}

		.slide ol>li.non-zero::before {
			content: attr(data-counter) ".";
		}

		h4 {
			font-size: .8em;
		}
		h2 + h4 {
			position: relative;
			top: -1.2em;
		}
		.clarification {
			margin-left: 2em;
			line-height: 1.6em;
		}
		.gap {
			text-align: center;
		}
			.gap h2 {
				font-size: 100px;
				margin-top: 140px;
				margin-right: 30px;
			}
		.slide ol + ol,
		.slide ul + ul {
			margin-top: -1em;
		}

		.red {
			color: rgb(200, 0, 0);
		}
		.jackie_chan {
			position: absolute;
			right: 0;
			bottom: 0;
			width: 400px;
		}
	</style>
</head>
<body class="shower list">

	<header class="caption">
		<h1>Работа с изображениями на Python в 2017 году</h1>
	</header>

	<!--section class="slide" id="cover" style="background-size: 1024px; background-image: url(./pictures/cover.markup.png)"-->
	<section class="slide" id="cover">
		<img src="./pictures/cover.png" alt="" width="180">
		<h2>
			Работа с изображениями<br>
			на Python в 2017 году
		</h2>
		<p>Александр Карпинский, Uploadcare</p>
		<style>
		#cover {
			color: rgb(23,23,23);
		}
			#cover:after {
				display: none;
				}
			#cover h2 {
				margin: 42px 0 0;
				font-size: 60px;
				line-height: 1.1;
				color: rgb(23,23,23);
				}
			#cover p {
				margin: 30px 0 0;
				font-size: 30px;
				}
		</style>
	</section>

	<section class="slide">
		<h2>O себе</h2>
		<p>
			Член команды <a href="https://python-pillow.org/">Pillow</a>.
		</p>
		<p>
			Автор <a href="https://github.com/uploadcare/pillow-simd">Pillow-SIMD</a>.
		</p>
	</section>

	<section class="slide">
		<h2>Чем занимаюсь</h2>
		<p>
			Сервис обработки картинок на лету в Uploadcare.
		</p>
		<ul>
			<li>Высокая производительность</li>
			<li>Надежность</li>
			<li>Масштабируемость</li>
			<li>Построен на Pillow</li>
		</ul>
	</section>



	<section class="slide gap">
		<h2>Библиотеки</h2>
	</section>

	<section class="slide">
		<h2>Pillow</h2>
		<ul>
			<li>Форк PIL (Python Imaging Library). 1995 год
			<li>Нативное расширение для Python
			<li>Версии Python: 2.7, 3.3+, pypy, pypy3
		</ul>
		<p>Сайт: <a href="https://python-pillow.org/">python-pillow.org</a></p>
	</section>

	<section class="slide">
		<h2>Pillow-SIMD</h2>
		<ul>
			<li>C мая 2016 года
			<li>Drop-in replacement for Pillow
			<li>Инструкции SSE4 (по умолчанию) и AVX2
		</ul>
		<p>Сайт: <a href="https://github.com/uploadcare/pillow-simd">github.com/uploadcare/pillow-simd</a></p>
	</section>

	<section class="slide">
		<h2>OpenCV</h2>
		<ul>
			<li>Расшифровывается Open Computer Vision. 2000 год
			<li>Биндинг на Python входит в комплект и очень популярен
			<li>Версии Python: 2.7, 3.4+, пока без pypy
		</ul>
		<p>Сайт: <a href="https://opencv.org/">opencv.org</a></p>
	</section>

	<section class="slide">
		<h2>VIPS</h2>
		<ul>
			<li>1993 год, обогнала своё время
			<li>Биндинг pyvips поддерживается автором
			<li>Версии Python: 2.7, 3.3+, pypy, pypy3
		</ul>
		<p>Сайт: <a href="https://jcupitt.github.io/libvips/">jcupitt.github.io/libvips/</a></p>
	</section>

	<section class="slide">
		<h2>ImageMagick &amp; GraphicsMagick</h2>
		<ul>
			<li>Очень популярная библиотека. 1990 год
			<li>Биндинг Wand использует ctypes, проект заброшен
			<li>Биндинг pgmagick использует Boost.Python, не работает в pypy
		</ul>
		<p>Сайт: <a href="https://www.imagemagick.org/">imagemagick.org</a>,
			<a href="http://graphicsmagick.org">graphicsmagick.org</a></p>
	</section>



	<section class="slide gap">
		<h2>Производительность</h2>
	</section>

	<section class="slide">
		<h2>Почему важно проверять результат</h2>
		<pre>
			<code>from PIL import Image, ImageFilter.BoxBlur</code>
			<code>im.filter(ImageFilter.BoxBlur(<mark>3</mark>))</code>
			<code>...</code>
		</pre>
		<pre>
			<code>import cv2</code>
			<code>cv2.blur(im, ksize=(<mark>3, 3</mark>))</code>
			<code>...</code>
		</pre>
	</section>

	<section class="slide">
		<h2>В чем проблема?</h2>
		<pre>
			<code>cv2.GaussianBlur(im, (window, window), radius)</code>
		</pre>
		<div style="columns: 2 auto">
			<div style="break-inside: avoid;">
				<code>radius = 3</code> <mark>58 ms</mark>
				<img src="./pictures/gaus.3.pillow.jpeg" width="90%">
			</div>
			<div style="break-inside: avoid;">
				<code>radius = 30</code> <mark>880 ms</mark>
				<img src="./pictures/gaus.30.pillow.jpeg" width="90%">
			</div>
		</div>
	</section>
	<section class="slide">
		<h2>В чем проблема?</h2>
		<pre>
			<code>im.filter(ImageFilter.GaussianBlur(radius))</code>
		</pre>
		<div style="columns: 2 auto">
			<div style="break-inside: avoid;">
				<code>radius = 3</code> <mark>60 ms</mark>
				<img src="./pictures/gaus.3.pillow.jpeg" width="90%">
			</div>
			<div style="break-inside: avoid;">
				<code>radius = 30</code> <mark>61 ms</mark>
				<img src="./pictures/gaus.30.pillow.jpeg" width="90%">
			</div>
		</div>
	</section>

	<section class="slide">
		<h2>Скорость ресайза в Pillow, Mpx/s</h2>
		<img src="./pictures/perf1.png" height="400">
	</section>
	<section class="slide">
		<h2>Скорость ресайза в Pillow, Mpx/s</h2>
		<img src="./pictures/perf2.png" height="400">
	</section>
	<section class="slide">
		<h2>Скорость ресайза в Pillow, Mpx/s</h2>
		<img src="./pictures/perf3.png" height="400">
	</section>
	<section class="slide">
		<h2>Скорость ресайза в Pillow, Mpx/s</h2>
		<img src="./pictures/perf4.png" height="400">
	</section>

	<section class="slide">
		<h2>Ускорение в Pillow-SIMD</h2>
		<ul>
			<li>Ресайз: от <mark>4</mark> до <mark>7</mark> раз</li>
			<li>Размытие: <mark>2,8</mark> раз</li>
			<li>Применение ядра 3x3 или 5x5: <mark>11</mark> раз</li>
			<li>Умножение и деление на альфа-канал: в <mark>4</mark> и <mark>10</mark> раза</li>
			<li>Альфа-композиция: <mark>5</mark> раз</li>
			<li>Еще что-то по мелочи</li>
		</ul>
	</section>

	<section class="slide">
		<h2>Какой-то набор операций, Mpx/s</h2>
		<p>Загрузка, поворот на 90°, уменьшение в 2,5 раза, размытие, запись в JPEG.</p>
		<img src="./pictures/perf5.png" height="330">
	</section>
	<section class="slide">
		<h2>Какой-то набор операций, Mpx/s</h2>
		<p>Если подождать и собрать самому.</p>
		<img src="./pictures/perf6.png" height="330">
	</section>

	<section class="slide">
		<h2>Набор бенчмарков</h2>
		<p>
			<b>Страница с результатами</b><br>
			<a href="https://python-pillow.org/pillow-perf/">https://python-pillow.org/pillow-perf/</a>
		</p>
		<p>
			<b>Фреймворк для тестирования</b><br>
			<a href="https://github.com/python-pillow/pillow-perf">https://github.com/python-pillow/pillow-perf</a>
		</p>
	</section>

	<!--section class="slide">
		<h2>Бенчмарки самого VIPS</h2>
		<img src="./pictures/vips-bench1.png" height="280">
		<p><a href="https://github.com/jcupitt/libvips/wiki/Speed-and-memory-use">
		https://github.com/jcupitt/libvips/wiki/Speed-and-memory-use</a></p>
	</section>

	<section class="slide">
		<h2>Бенчмарки самого VIPS</h2>
		<img src="./pictures/vips-bench2.png" height="280">
		<p>1. Pillow is single-threaded, so the fairest comparison
			 for raw processing speed would be against vips-1thread.</p>
	</section-->



	<section class="slide gap">
		<h2>Параллельная работа</h2>
	</section>

	<section class="slide">
		<h2>Метрики производительности</h2>
		<ul>
			<li><b>Реальное время выполнения одной операций</b><br>
				Важно на десктопе.
			</li>
			<li><b>Пропускная способность потока операций</b><br>
				Становится более важным на сервере.
			</li>
		</ul>
	</section>

	<section class="slide">
		<h2>Способы параллельной работы</h2>
		<ol>
			<li class="non-zero" data-counter="1">На уровне приложения</li>
		</ol>
		<p>
			Реальное время выполнения не меняется.<br>
			Пропускная способность растет пропорционально количеству ядер.
		</p>
	</section>

	<section class="slide">
		<h2>Способы параллельной работы</h2>
		<ol>
			<li class="non-zero" data-counter="2">На уровне графических операций</li>
		</ol>
		<p>
			Реальное время выполнения уменьшается.<br>
			Пропускная способность растет далеко не линейно от количества ядер.
		</p>
	</section>

	<section class="slide">
		<h2>Способы параллельной работы</h2>
		<ol>
			<li class="non-zero" data-counter="3">На уровне команд процессора и данных (SIMD)</li>
		</ol>
		<p>
			Реальное время выполнения уменьшается.<br>
			Пропускная способность растет.<br>
			Win-win.
		</p>
	</section>

	<section class="slide">
		<h2>Как совместить параллельную работу</h2>
		<div class="puzzles">
			<img src="./pictures/puzzle4.png" style="opacity: 0.8;">
			<span style="top: 80px; left: 30px; font-size: 40px;">SIMD</span>
			<span style="left: 190px; width: 170px; top: 20px;">внутри операций</span>
			<span style="top: 230px; width: 170px; left: 20px;">внутри приложения</span>
		</div>
		<style type="text/css">
			.puzzles {
				position: relative;
				margin: 0 auto;
				width: 400px;
			}
			.puzzles > * {
				position: absolute;
				text-align: center;
			}
		</style>
	</section>

	<section class="slide">
		<h2>Многопоточность</h2>
		<p>
			<b>Отпускают GIL</b><br>
			Pillow, OpenCV, pyvips, Wand
		</p>
		<p><b>Не отпускает</b><br>
			pgmagick</p>
	</section>

	<section class="slide">
		<h2>Правило N + 1</h2>
		<p>
			Создавать для обработки <mark>не более</mark> N + 1 воркеров,<br>
			где N — количество ядер или потоков процессора.
		</p>
		<p>Воркер — процесс или поток, занятый обработкой.</p>
	</section>

	<section class="slide">
		<h2>Асинхронная работа</h2>
		<p>
			Долгая работа процессора блокирует event loop,<br>
			даже если библиотека отпускает GIL.
		</p>
		<pre>
			<code>@gen.coroutine</code>
    	<code>def get(self, *args, **kwargs):</code>
			<code>    im = <mark>process_image</mark>(...)</code>
    	<code>    ...</code>
		</pre>
	</section>

	<section class="slide">
		<h2>Асинхронная работа</h2>
		<pre>
			<code>@run_on_executor(executor=ThreadPoolExecutor(<mark>1</mark>))</code>
    	<code>def process_image(self, ...):</code>
    	<code>    ...</code>
    	<code>@gen.coroutine</code>
    	<code>def get(self, *args, **kwargs):</code>
			<code>    im = <mark>yield</mark> process_image(...)</code>
			<code>    ...</code>
		<pre>
		</pre>
	</section>



	<section class="slide gap">
		<h2>Ввод/Вывод</h2>
	</section>

	<!--section class="slide">
		<h2>Поддерживаемые форматы</h2>	
		<ul>
			<li>Pillow: Кодеки для 17 форматов + декодеры еще для 18</li>
			<li>OpenCV: Кодеки для 8 форматов, включая WebP и JPEG 2000</li>
			<li>ImageMagick: Кодеки для 66 форматов + декодеры для 34</li>
			<li>VIPS: порядка 12 сам + может использовать ImageMagick</li>
		</ul>
	</section-->

	<section class="slide">
		<h2>Ленивая загрузка</h2>
		<pre>
			<code>>>> from PIL import Image</code>
			<code>>>> <mark>%time</mark> im = Image.open('cover.jpg')</code>
			<code>Wall time: <mark>1.2 ms</mark></code>
			<code>>>> im.mode, im.size</code>
			<code>('RGB', (2152, 1345))</code>
		</pre>
	</section>

	<section class="slide">
		<h2>Ленивая загрузка</h2>
		<pre>
			<code>>>> from PIL import Image</code>
			<code>>>> <mark>%time</mark> im = Image.open('cover.jpg')</code>
			<code>Wall time: <mark>1.2 ms</mark></code>
			<code>>>> im.mode, im.size</code>
			<code>('RGB', (2152, 1345))</code>
			<code>>>> <mark>%time</mark> im.load()</code>
			<code>Wall time: <mark>73.6 ms</mark></code>
		</pre>
	</section>

	<section class="slide">
		<h2>Режим битых картинок</h2>
		<pre>
			<code>from PIL import Image</code>
			<code>Image.open('trucated.jpg').save('trucated.out.jpg')</code>
			<code><mark>IOError</mark>: image file is truncated (143 bytes not processed)</code>
		</pre>
	</section>

	<section class="slide">
		<h2>Режим битых картинок</h2>
		<pre>
			<code>from PIL import Image, ImageFile</code>
			<code>ImageFile.<mark>LOAD_TRUNCATED_IMAGES</mark> = True</code>
			<code>Image.open('trucated.jpg').save('trucated.out.jpg')</code>
		</pre>
		<img src="./pictures/trucated.out.jpg">
	</section>

	<section class="slide">
		<h2></h2>
		<table>
			<tr>
				<th width="40%"></th>
				<th width="11%">Pillow</th>
				<th width="11%">VIPS</th>
				<th width="11%">OpenCV</th>
				<th width="20%">IM</th>
			</tr>
			<tr>
				<td>Количество кодеков</td>
				<td>17</td>
				<td>12+</td>
				<td>8</td>
				<td>66</td>
			</tr>
			<tr>
				<td>Битые картинки</td>
				<td>✅</td>
				<td>✅</td>
				<td>✅</td>
				<td>✅</td>
			</tr>
			<tr>
				<td>Ленивая загрузка</td>
				<td>✅</td>
				<td>✅</td>
				<td>❌</td>
				<td>❌</td>
			</tr>
			<tr>
				<td>Чтение EXIF и ICC</td>
				<td>✅</td>
				<td>✅</td>
				<td>❌</td>
				<td>✅</td>
			</tr>
			<tr>
				<td>Автоповорот EXIF</td>
				<td>❌</td>
				<td>✅</td>
				<td>✅</td>
				<td>✅</td>
			</tr>
		</table>
	</section>

	<section class="slide">
		<h2>Особенности OpenCV</h2>
		<pre>
			<code>cv2.imread(filename)</code>
		</pre>
		<ul>
			<li>Поворачивает JPEG-файлы в соответствии с EXIF
			<li>Игнорирует альфа-канал у PNG-файлов
		</ul>
	</section>
	<section class="slide">
		<h2>Особенности OpenCV</h2>
		<pre>
			<code>cv2.imread(filename, flags=<mark>cv2.IMREAD_UNCHANGED</mark>)</code>
		</pre>
		<ul>
			<li>Оставляет альфа-канал у PNG-файлов
			<li>Перестает поворачивать JPEG-файлы
		</ul>
	</section>
	<!--section class="slide">
		<h2>Особенности OpenCV</h2>
		<pre>
			<code>cv2.imread(filename, flags=<mark>cv2.IMREAD_UNCHANGED</mark>)</code>
		</pre>
		<ul>
			<li>Оставляет альфа-канал у PNG-файлов
			<li>Перестает поворачивать JPEG-файлы
		</ul>
		<img src="./pictures/jackie_chan.jpeg" class="jackie_chan">
	</section-->

	<section class="slide">
		<h2>Почему так?</h2>
		<ul>
			<li>Мало кодеков</li>
			<li>Нет ленивой загрузки</li>
			<li>Нет доступа к EXIF и ICC</li>
			<li>Странное флаги</li>
		</ul>
		<p>OpenCV не рассчитан на работу с непроверенными источниками.</p>
	</section>

	<section class="slide">
		<h2>Решение</h2>
		<img src="./pictures/apple.jpg" style="height: 250px; margin: 20px 80px 0;">
		<img src="./pictures/pen.png" style="height: 280px;">
	</section>

	<section class="slide">
		<h2>Решение</h2>
		<p>Изображение в OpenCV — это массив numpy.</p>
		<pre>
			<code>import numpy</code>
			<code>from PIL import Image</code>
			<code>...</code>
			<code>pillow_image = Image.open(filename)</code>
			<code>cv_image = <mark>numpy.array</mark>(pillow_image)</code>
		</pre>
	</section>

	<section class="slide">
		<h2>Решение</h2>
		<pre>
			<code>import numpy</code>
			<code>from PIL import Image</code>
			<code>...</code>
			<code>pillow_image = <mark>Image.fromarray</mark>(cv_image, "RGB")</code>
			<code>pillow_image.save(filename)</code>
		</pre>
	</section>

	<section class="slide gap">
		<h2 style="margin: 80px 0;">Вопросы</h2>
		<p>Презентация: <a href="https://homm.github.io/image-libs-2017/">homm.github.io/image-libs-2017/</a></p>
		<p>Написать: <a href="mailto:homm86@gmail.com">homm86@gmail.com</a></p>
	</section>



	<div class="progress"></div>

	<script src="node_modules/shower-core/shower.min.js"></script>
	<!-- Copyright © 2017 Yours Truly, Famous Inc. -->

</body>
</html>
